<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THE MOON / SUPREMATISM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #EFEBD6; 
            --ink-black: #0a0a0a; 
            --soviet-red: #D62828;
            --grid-line: #1a1a1a;
        }

        body {
            background-color: var(--bg-color);
            color: var(--ink-black);
            font-family: 'Oswald', sans-serif;
            height: 100dvh;
            width: 100vw;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            text-transform: uppercase;
            background-image: radial-gradient(#000 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        /* 背景几何体 */
        .art-block-1 {
            position: absolute;
            top: -5%; left: -10%; width: 60%; height: 45%;
            background-color: var(--soviet-red);
            transform: rotate(-15deg);
            z-index: 0;
        }
        .art-block-2 {
            position: absolute;
            bottom: 5%; right: 5%; width: 30px; height: 100%;
            background-color: var(--ink-black);
            transform: rotate(25deg);
            z-index: 0;
        }
        .art-block-3 {
            position: absolute;
            bottom: 15%; left: -5%; width: 20%; height: 15px;
            background-color: var(--soviet-red);
            transform: rotate(0deg);
            z-index: 0;
        }

        #app-container {
            width: 100%; height: 100%; max-width: 430px;
            background: transparent; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            padding: env(safe-area-inset-top, 40px) 20px env(safe-area-inset-bottom, 20px) 20px;
            z-index: 1;
            border: 4px solid var(--ink-black); 
            box-sizing: border-box;
            background-color: rgba(239, 235, 214, 0.85); 
        }

        /* 标题区 */
        h1 {
            font-weight: 700; font-size: 4.5rem; line-height: 0.8;
            letter-spacing: -0.02em; color: var(--ink-black);
            text-align: left; width: 100%;
            border-bottom: 6px solid var(--ink-black);
            padding-bottom: 10px; margin-bottom: 5px; z-index: 10;
        }
        .phase-name {
            font-weight: 600; font-size: 1.5rem; color: var(--soviet-red);
            background: var(--ink-black); padding: 2px 10px;
            align-self: flex-start; transform: skewX(-10deg); margin-bottom: 1rem;
        }

        /* 罗盘系统 */
        .compass-wrapper {
            position: relative; width: 85%; aspect-ratio: 1 / 1;
            flex-shrink: 0; display: flex; justify-content: center; align-items: center;
            margin: 10px 0; border: 2px solid var(--ink-black);
            border-radius: 50%; background: transparent;
        }

        /* 关键修改：给罗盘旋转层添加过渡效果 
           配合 JS 的 0.2s 节流，实现平滑转动 
        */
        .dial-rotator {
            width: 100%;
            height: 100%;
            position: absolute;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* 稍长于刷新间隔，确保平滑 */
            will-change: transform;
        }

        .tick {
            background-color: transparent; width: 2px; height: 50%;
            left: 50%; top: 0; position: absolute; transform-origin: bottom center;
        }
        .tick::after {
            content: ''; position: absolute; top: 0; left: -1px; width: 100%;
            background-color: var(--ink-black); 
        }
        .tick.major::after { height: 20px; width: 6px; left: -3px; background-color: var(--soviet-red); }
        .tick.medium::after { height: 15px; width: 3px; left: -1.5px; }
        .tick.minor::after { height: 8px; width: 1px; }

        .dial-number {
            color: var(--ink-black); font-weight: 700; font-size: 1.1rem;
            position: absolute; text-align: center; width: 30px; height: 30px;
            line-height: 30px;
        }

        .red-pointer-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 30;
            transition: transform 0.5s ease-out; /* 红指针单独的平滑逻辑 */
        }
        .red-pointer {
            position: absolute; top: 5%; left: 50%; margin-left: -2px; 
            width: 4px; height: 45%; background-color: var(--soviet-red); border: none;
        }
        .red-pointer::before {
            content: ''; position: absolute; top: 0; left: -8px; width: 0; height: 0; 
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-top: 20px solid var(--soviet-red);
        }

        .moon-visual {
            position: absolute; width: 40%; height: 40%; border-radius: 50%;
            background: var(--ink-black); z-index: 10; box-shadow: none;
            border: 4px solid var(--bg-color); 
        }
        
        .viewfinder-static::before, .viewfinder-static::after {
            content: ''; position: absolute; background: var(--soviet-red);
            opacity: 0.5; z-index: 5;
        }
        .viewfinder-static::before { width: 1px; height: 100vh; }
        .viewfinder-static::after { width: 100vw; height: 1px; }

        .time-block {
            border: 2px solid var(--ink-black); padding: 5px 10px;
            background: var(--bg-color); position: relative; z-index: 20;
        }
        #left-time-label, #right-time-label {
            color: var(--soviet-red); font-weight: 700; font-size: 0.7rem;
        }
        #left-time-value, #right-time-value {
            color: var(--ink-black); font-weight: 600;
        }

        #moon-status-text {
            background: var(--ink-black); color: var(--bg-color);
            padding: 2px 8px; font-weight: 600; font-size: 0.8rem;
            letter-spacing: 0.05em; transform: translateY(-10px);
            opacity: 1 !important; filter: none !important;
        }

        .footer-stat-container {
            position: relative; width: 100%; display: flex;
            justify-content: space-between; align-items: flex-end;
            border-top: 6px solid var(--ink-black); padding-top: 1rem;
            overflow: visible; 
        }
        .big-number-box {
            font-size: 10rem; line-height: 1; color: var(--ink-black);
            font-weight: 700; position: absolute; bottom: -30px; left: -15px;
            z-index: 0; opacity: 0.15; white-space: nowrap;
        }
        .big-number-box::after {
            content: attr(data-val); position: absolute; left: 15px; bottom: 30px;
            font-size: 5rem; color: var(--ink-black); opacity: 1; z-index: 10;
        }

        .stat-text-col {
            z-index: 10; background: var(--bg-color); padding-left: 10px;
            margin-left: auto; 
        }
        .stat-line-top {
            font-size: 1.5rem; color: var(--soviet-red); font-weight: 700;
            display: block; text-align: right;
        }
        .stat-line-bottom {
            font-size: 2rem; color: var(--ink-black); font-weight: 700;
            display: flex; align-items: baseline; justify-content: flex-end;
        }
        .percent-mark {
            color: var(--soviet-red); font-size: 1.5rem; margin-right: 5px;
        }

        #location-text {
            color: var(--ink-black); font-weight: 600; font-size: 1rem;
            border: 2px solid var(--ink-black); padding: 5px 15px;
            margin-bottom: 1rem; background: var(--bg-color); z-index: 20;
            box-shadow: 4px 4px 0px var(--soviet-red); 
        }

        #quote-text {
            color: var(--ink-black); font-weight: 600; text-align: center;
            border-top: 1px solid var(--ink-black); padding-top: 10px;
            width: 100%; font-style: italic;
        }
    </style>
</head>
<body>
    
    <div class="art-block-1"></div>
    <div class="art-block-2"></div>
    <div class="art-block-3"></div>

    <div id="app-container">
        <header class="flex flex-col w-full z-10 relative">
            <h1 class="tracking-tighter">MOON<span style="color:var(--soviet-red)">.</span>POS</h1>
            <div id="phase-name" class="phase-name">--</div>
        </header>
    
        <div class="compass-wrapper z-10">
            <div class="dial-rotator" id="dial-rotator">
                <div id="arc-container"></div>
                <!-- 红色指针独立于 dial-rotator 旋转，但为了层级放在这里 -->
                <div id="red-pointer-rotator" class="red-pointer-container">
                     <div class="red-pointer"></div>
                </div>
            </div>
            <div class="viewfinder-static flex justify-center items-center">
                <div class="moon-visual" id="moon-visual"></div>
            </div>
        </div>
    
        <div class="w-full flex justify-between items-end px-0 mt-4 z-10">
            <div class="time-block flex flex-col items-start">
                <span id="left-time-label">--</span>
                <span id="left-time-value" class="text-3xl leading-none">--:--</span>
            </div>
            
            <span id="moon-status-text">LOCATING...</span>
            
            <div class="time-block flex flex-col items-end text-right">
                <span id="right-time-label">--</span>
                <span id="right-time-value" class="text-3xl leading-none">--:--</span>
            </div>
        </div>
    
        <div class="flex flex-col items-center w-full mb-0 flex-shrink-0 z-10 flex-grow justify-end">
            <div class="footer-stat-container mb-6">
                <div id="illumination-value" class="big-number-box">--</div>
                <div class="stat-text-col">
                    <span class="stat-line-top">VISIBILITY</span>
                    <div class="stat-line-bottom">
                        <span class="percent-mark">%</span>
                        <span id="moon-direction-text">--</span>
                    </div>
                </div>
            </div>

            <div id="location-text">DETECTING SECTOR...</div>
            
            <div id="quote-text">
                We shall meet in the place where there is no darkness
            </div>
        </div>
    </div>

    <script>
        /* ============================================================
           INLINE SUNCALC LIBRARY (Keep Inline for Reliability)
           ============================================================ */
        var SunCalc = (function () {
            'use strict';
            var PI=Math.PI,sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,atan=Math.atan2,acos=Math.acos,rad=PI/180;
            var dayMs=1000*60*60*24,J1970=2440588,J2000=2451545;
            function toJulian(date){return date.valueOf()/dayMs-0.5+J1970;}
            function toDays(date){return toJulian(date)-J2000;}
            function toDate(j){return new Date((j+0.5-J1970)*dayMs);}
            var e=rad*23.4397;
            function rightAscension(l,b){return atan(sin(l)*cos(e)-tan(b)*sin(e),cos(l));}
            function declination(l,b){return asin(sin(b)*cos(e)+cos(b)*sin(e)*sin(l));}
            function azimuth(H,phi,dec){return atan(sin(H),cos(H)*sin(phi)-tan(dec)*cos(phi));}
            function altitude(H,phi,dec){return asin(sin(phi)*sin(dec)+cos(phi)*cos(dec)*cos(H));}
            function siderealTime(d,lw){return rad*(280.16+360.9856235*d)-lw;}
            function astroRefraction(h){if(h<0)h=0;return 0.0002967/Math.tan(h+0.00312536/(h+0.08901179));}
            function moonCoords(d){var L=rad*(218.316+13.176396*d),M=rad*(134.963+13.064993*d),F=rad*(93.272+13.229350*d),l=L+rad*6.289*sin(M),b=rad*5.128*sin(F),dt=385001-20905*cos(M);return{ra:rightAscension(l,b),dec:declination(l,b),dist:dt};}
            var SunCalc={};
            SunCalc.getMoonPosition=function(date,lat,lng){var lw=rad*-lng,phi=rad*lat,d=toDays(date),c=moonCoords(d),H=siderealTime(d,lw)-c.ra,h=altitude(H,phi,c.dec),pa=atan(sin(H),tan(phi)*cos(c.dec)-sin(c.dec)*cos(H));h=h+astroRefraction(h);return{azimuth:azimuth(H,phi,c.dec),altitude:h,distance:c.dist,parallacticAngle:pa};};
            SunCalc.getMoonIllumination=function(date){var d=toDays(date||new Date()),s={ra:rightAscension(rad*(280.16+0.9856263*d),0),dec:declination(rad*(280.16+0.9856263*d),0)},m=moonCoords(d),sdist=149598000,phi=acos(sin(s.dec)*sin(m.dec)+cos(s.dec)*cos(m.dec)*cos(s.ra-m.ra)),inc=atan(sdist*sin(phi),m.dist-sdist*cos(phi)),angle=atan(cos(s.dec)*sin(s.ra-m.ra),sin(s.dec)*cos(m.dec)-cos(s.dec)*sin(m.dec)*cos(s.ra-m.ra));return{fraction:(1+cos(inc))/2,phase:0.5+0.5*inc*(angle<0?-1:1)/Math.PI,angle:angle};};
            SunCalc.getMoonTimes=function(date,lat,lng,inUTC){var t=new Date(date);if(inUTC)t.setUTCHours(0,0,0,0);else t.setHours(0,0,0,0);var hc=0.133*rad,h0=SunCalc.getMoonPosition(t,lat,lng).altitude-hc,h1,h2,rise,set,a,b,xe,ye,d,roots,x1,x2,dx;var result={};for(var i=1;i<=24;i+=2){h1=SunCalc.getMoonPosition(new Date(t.valueOf()+i*dayMs/24),lat,lng).altitude-hc;h2=SunCalc.getMoonPosition(new Date(t.valueOf()+(i+1)*dayMs/24),lat,lng).altitude-hc;a=(h0+h2)/2-h1;b=(h2-h0)/2;xe=-b/(2*a);ye=(a*xe+b)*xe+h1;d=b*b-4*a*h1;roots=0;if(d>=0){dx=Math.sqrt(d)/(2*Math.abs(a));x1=xe-dx;x2=xe+dx;if(Math.abs(x1)<=1)roots++;if(Math.abs(x2)<=1)roots++;if(x1<-1)x1=x2;}if(roots===1){if(h0<0)result.rise=i+x1;else result.set=i+x1;}else if(roots===2){result.rise=i+(ye<0?x2:x1);result.set=i+(ye<0?x1:x2);}if(result.rise&&result.set)break;h0=h2;}if(result.rise)result.rise=new Date(t.valueOf()+result.rise*3600000);if(result.set)result.set=new Date(t.valueOf()+result.set*3600000);if(!result.rise&&!result.set){var val=SunCalc.getMoonPosition(new Date(t.valueOf()+12*3600000),lat,lng).altitude>hc?'alwaysUp':'alwaysDown';result[val]=true;}return result;};
            return SunCalc;
        }());

        // DOM Elements
        const arcContainer = document.getElementById('arc-container');
        const dialRotator = document.getElementById('dial-rotator');
        const redPointerRotator = document.getElementById('red-pointer-rotator');
        
        const phaseNameEl = document.getElementById('phase-name');
        const leftTimeLabelEl = document.getElementById('left-time-label');
        const leftTimeValueEl = document.getElementById('left-time-value');
        const rightTimeLabelEl = document.getElementById('right-time-label');
        const rightTimeValueEl = document.getElementById('right-time-value');
        const statusTextEl = document.getElementById('moon-status-text');
        const illuminationEl = document.getElementById('illumination-value');
        const directionTextEl = document.getElementById('moon-direction-text');
        const locationEl = document.getElementById('location-text');
        const quoteEl = document.getElementById('quote-text');

        const step = 5; 

        // Init Dial
        for (let deg = 0; deg < 360; deg += step) {
            const tick = document.createElement('div');
            let type = 'minor';
            let isMajor = false;
            
            if (deg % 90 === 0) { type = 'major'; isMajor = true; } 
            else if (deg % 30 === 0) type = 'major'; 
            else if (deg % 10 === 0) type = 'medium';

            tick.className = `tick ${type}`;
            tick.style.transform = `translateX(-50%) rotate(${deg}deg)`;
            arcContainer.appendChild(tick);

            if (isMajor || deg % 30 === 0) {
                const num = document.createElement('div');
                num.className = 'dial-number';
                
                let label = deg.toString();
                if (deg === 0) label = 'N';
                if (deg === 90) label = 'E';
                if (deg === 180) label = 'S';
                if (deg === 270) label = 'W';
                
                num.innerText = label; 
                
                const rad = deg * (Math.PI / 180);
                const radius = 40; 
                const x = 50 + (radius * Math.sin(rad)); 
                const y = 50 - (radius * Math.cos(rad));
                
                num.style.left = `${x}%`;
                num.style.top = `${y}%`;
                num.style.transform = `translate(-50%, -50%) rotate(${deg}deg)`;

                arcContainer.appendChild(num);
            }
        }

        let currentLat = 0;
        let currentLng = 0;
        
        const quotes = [
            "We shall meet in the place where there is no darkness"
        ];
        quoteEl.innerText = quotes[Math.floor(Math.random() * quotes.length)];

        function formatTime(date) {
            if (!date || isNaN(date)) return '--:--';
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function getMoonEventsForDate(date, lat, lng) {
            try {
                const times = SunCalc.getMoonTimes(date, lat, lng);
                const events = [];
                if (times && times.rise) events.push({ type: 'MOONRISE', time: times.rise });
                if (times && times.set) events.push({ type: 'MOONSET', time: times.set });
                return events;
            } catch (e) {
                console.warn("Error calc moon events", e);
                return [];
            }
        }

        // Safe Update Function
        function updateMoonData() {
            try {
                const now = new Date();
                
                // 1. Illumination Phase
                const illumination = SunCalc.getMoonIllumination(now);
                const phasePercent = Math.round(illumination.fraction * 100);
                illuminationEl.innerText = phasePercent;
                illuminationEl.setAttribute('data-val', phasePercent);
                
                const phase = illumination.phase; 
                let pName = "New Moon";
                if (phase > 0 && phase < 0.25) pName = "Waxing Crescent";
                else if (phase >= 0.25 && phase < 0.5) pName = "Waxing Gibbous"; 
                else if (phase >= 0.48 && phase <= 0.52) pName = "Full Moon";
                else if (phase > 0.5 && phase < 0.75) pName = "Waning Gibbous";
                else if (phase >= 0.75 && phase < 1) pName = "Waning Crescent";
                
                if (Math.abs(phase - 0.25) < 0.02) pName = "First Quarter";
                if (Math.abs(phase - 0.75) < 0.02) pName = "Last Quarter";
                if (Math.abs(phase - 0.0) < 0.02 || Math.abs(phase - 1.0) < 0.02) pName = "New Moon";
                
                phaseNameEl.innerText = pName;

                // 2. Moon Position & Times (Only if Geo is valid)
                // 使用 Try-Catch 包裹这部分，防止GPS数据导致 Crash
                if (typeof currentLat === 'number' && typeof currentLng === 'number') {
                    const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
                    const tomorrow = new Date(now); tomorrow.setDate(tomorrow.getDate() + 1);

                    let events = [
                        ...getMoonEventsForDate(yesterday, currentLat, currentLng),
                        ...getMoonEventsForDate(now, currentLat, currentLng),
                        ...getMoonEventsForDate(tomorrow, currentLat, currentLng)
                    ];

                    events.sort((a, b) => a.time - b.time);

                    let prevEvent = null;
                    let nextEvent = null;

                    for (let i = 0; i < events.length; i++) {
                        if (events[i].time > now) {
                            nextEvent = events[i];
                            prevEvent = events[i - 1];
                            break;
                        }
                    }
                    
                    if (!nextEvent && events.length > 0) {
                         prevEvent = events[events.length - 1];
                    }

                    if (prevEvent) {
                        leftTimeLabelEl.innerText = prevEvent.type;
                        leftTimeValueEl.innerText = formatTime(prevEvent.time);
                    }

                    if (nextEvent) {
                        rightTimeLabelEl.innerText = nextEvent.type;
                        rightTimeValueEl.innerText = formatTime(nextEvent.time);

                        const diffMs = nextEvent.time - now;
                        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        
                        const action = nextEvent.type === 'MOONRISE' ? 'RISE' : 'SET';
                        
                        let timeString = "";
                        if (diffHrs > 0) {
                            timeString = `${diffHrs}H ${diffMins}M`;
                        } else {
                            timeString = `${diffMins}M`;
                        }
                        statusTextEl.innerText = `MOON WILL ${action} IN ${timeString}`;
                    }
                    
                    const pos = SunCalc.getMoonPosition(now, currentLat, currentLng);
                    const moonAzimuth = (pos.azimuth * (180/Math.PI)) + 180;
                    
                    const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                    const dirIndex = Math.round(moonAzimuth / 45) % 8;
                    directionTextEl.innerText = `AT ${dirs[dirIndex]}`;
                    
                    if(redPointerRotator) {
                        redPointerRotator.style.transform = `rotate(${moonAzimuth}deg)`;
                    }
                }
            } catch (err) {
                console.error("Update Loop Error:", err);
                // 保持界面不为空白，可以设置一些默认值
                locationEl.innerText = "DATA ERROR";
            }
        }

        function initGeo() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    console.log("Geo Success", position);
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    
                    // 立即更新一次数据，防止等待城市名抓取时数据消失
                    updateMoonData();

                    try {
                        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLat}&lon=${currentLng}&zoom=10&accept-language=en`;
                        const resp = await fetch(url, { headers: { 'User-Agent': 'MoonApp/1.0' } });
                        if(resp.ok) {
                            const data = await resp.json();
                            const city = data.address.city || data.address.town || data.address.village || "Sector 7";
                            locationEl.innerText = `${city.toUpperCase()}`;
                        } else {
                             locationEl.innerText = `${currentLat.toFixed(2)}, ${currentLng.toFixed(2)}`;
                        }
                    } catch (e) {
                        console.warn("City fetch failed", e);
                        locationEl.innerText = `${currentLat.toFixed(2)}, ${currentLng.toFixed(2)}`;
                    }
                    
                    // 再次更新以确保一切就绪
                    updateMoonData();
                    
                }, (err) => {
                    locationEl.innerText = "ACCESS DENIED";
                    console.warn(err);
                }, {
                    enableHighAccuracy: false, // 降低精度要求以提高成功率
                    timeout: 10000,
                    maximumAge: 60000
                });
            } else {
                locationEl.innerText = "GEO NOT SUPPORTED";
            }
        }

        // 陀螺仪节流相关变量
        let lastCompassUpdate = 0;
        const COMPASS_THROTTLE_MS = 200; // 0.2秒检测一次

        function initCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                document.body.addEventListener('click', async () => {
                     try {
                        const response = await DeviceOrientationEvent.requestPermission();
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                     } catch(e) {
                         console.error(e);
                     }
                }, { once: true });
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            const now = Date.now();
            
            // 节流逻辑：如果距离上次更新小于 200ms，则直接跳过
            if (now - lastCompassUpdate < COMPASS_THROTTLE_MS) {
                return;
            }
            
            lastCompassUpdate = now;

            let heading = 0;
            
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } else if (event.alpha) {
                if (event.absolute) {
                    heading = 360 - event.alpha;
                } else {
                    heading = 360 - event.alpha;
                }
            }
            
            // 由于 CSS transition 设置为 0.3s，这里的每 0.2s 更新会自动变得平滑
            dialRotator.style.transform = `rotate(-${heading}deg)`;
        }

        initGeo();
        initCompass();
        updateMoonData();
        setInterval(updateMoonData, 60000);

    </script>
</body>
</html>